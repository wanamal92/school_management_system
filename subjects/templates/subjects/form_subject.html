{% extends 'base.html' %}
{% load static %}

{% if messages %}
    {% for message in messages %}
        <div class="alert 
            {% if message.tags == 'success' %}
                alert-success
            {% elif message.tags == 'error' %}
                alert-danger
            {% else %}
                alert-info
            {% endif %} alert-dismissible fade show" role="alert">
            
            <!-- Message content -->
            <p>{{ message }}</p>
            
            <!-- Close button (X) -->
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

{% block content %}
<h1>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Subject</h1>

<form method="POST">
  {% csrf_token %}
  {{ form.as_p }}

  <h4>Assign Teachers</h4>
  <table class="table table-bordered" id="teacher-table">
    <thead>
      <tr>
        <th>Teacher</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {{ formset.management_form }}
      {% for form in formset %}
      <tr class="form-row">
        <td>
          {{ form.teacher }}
          {{ form.id }}
        </td>
        <td>
          <button type="button" class="btn btn-danger btn-sm delete-row">‚ùå</button>
          {{ form.DELETE }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="button" id="add-row" class="btn btn-outline-secondary">+ Add a line</button>
  <br><br>

  <div class="col-12 mt-3">
    <button type="submit" class="btn btn-success">
      <i class="fas fa-save me-1"></i> Save
    </button>
    <a href="{% url 'list_subject' %}" class="btn btn-secondary">
      <i class="fas fa-times me-1"></i> Cancel
    </a>
  </div>
</form>

<script>
  const addButton = document.getElementById('add-row');
  const tableBody = document.querySelector('#teacher-table tbody');
  const totalForms = document.getElementById('id_teachersubject_set-TOTAL_FORMS');

  // DELETE button action
  tableBody.addEventListener('click', function (e) {
    if (e.target.classList.contains('delete-row')) {
      const row = e.target.closest('tr');
      const deleteCheckbox = row.querySelector('input[type=checkbox][name$="-DELETE"]');
      if (deleteCheckbox) {
        deleteCheckbox.checked = true;
        row.style.display = 'none';
      } else {
        row.remove();
        totalForms.value = parseInt(totalForms.value) - 1;
      }
    }
  });

  // ADD button action
  addButton.addEventListener('click', () => {
    const formCount = parseInt(totalForms.value);
    const emptyRow = document.querySelector('.form-row');
    const newRow = emptyRow.cloneNode(true);

    newRow.querySelectorAll('input, select').forEach(input => {
      if (input.name) input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
      if (input.id) input.id = input.id.replace(/-\d+-/, `-${formCount}-`);
      if (input.type === 'checkbox') {
        input.checked = false;
        if (input.name.includes('DELETE')) {
          input.style.display = 'none'; // hide delete checkbox
        }
      } else {
        input.value = '';
      }
    });

    tableBody.appendChild(newRow);
    totalForms.value = formCount + 1;
  });
</script>
{% endblock %}