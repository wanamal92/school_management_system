{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/audit.css' %}">
<script src="{% static 'js/audit.js' %}"></script>

<div class="container mt-4">
    <h3>Audit Log</h3>

    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="audit-search" class="form-control" placeholder="Search by username">
        </div>
        <div class="col-md-4">
            <select id="action-filter" class="form-select">
                <option value="">Filter by Action</option>
                <option value="create">Created</option>
                <option value="delete">Deleted</option>
                <option value="deactivate">Deactivated</option>
                <option value="reactivate">Reactivated</option>
            </select>
        </div>
    </div>
    {% if messages %}
    <div class="alert alert-info" role="alert">
        {% for message in messages %}
        <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}
    <hr>

    <div class="table-responsive">
        <table class="table table-bordered table-striped" id="audit-table">
            <thead class="table-dark">
                <tr>
                    <th>Performed By</th>
                    <th>Action</th>
                    <th>Target User</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td class="by">{{ log.performed_by.username }}</td>
                    <td>
                        {% if log.action == 'create' %}
                        <span class="text-success fw-bold action">Created</span>
                        {% elif log.action == 'delete' %}
                        <span class="text-danger fw-bold action">Deleted</span>
                        {% elif log.action == 'deactivate' %}
                        <span class="text-warning fw-bold action">Deactivated</span>
                        {% elif log.action == 'reactivate' %}
                        <span class="text-primary fw-bold action">Reactivated</span>
                        {% endif %}
                    </td>

                    <td class="target">{{ log.target_user.username }}</td>
                    <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("audit-search");
        const actionFilter = document.getElementById("action-filter");
        const rows = document.querySelectorAll("#audit-table tbody tr");

        function filterTable() {
            const search = searchInput.value.toLowerCase();
            const action = actionFilter.value.toLowerCase();

            rows.forEach(row => {
                const by = row.querySelector(".by").textContent.toLowerCase();
                const target = row.querySelector(".target").textContent.toLowerCase();
                const rowAction = row.querySelector(".action").textContent.toLowerCase();

                // Check if search term matches performed by or target username
                const matchesSearch = by.includes(search) || target.includes(search);
                // Check if action filter matches the action text in the row
                const matchesAction = !action || rowAction.includes(action);

                row.style.display = matchesSearch && matchesAction ? "" : "none";
            });
        }

        searchInput.addEventListener("input", filterTable);
        actionFilter.addEventListener("change", filterTable);
    });
</script>
{% endblock %}
